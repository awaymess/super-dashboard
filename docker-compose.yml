# Compose file version key is obsolete in recent Docker Compose; remove to avoid warnings.

# Super Dashboard Docker Compose Configuration
# 
# Environment Variables:
#   - ENV: Application environment (development/production)
#   - PORT: Server port (default: 8080)
#   - USE_MOCK_DATA: Enable mock data mode (default: true)
#   - DATABASE_URL: PostgreSQL connection string
#   - REDIS_URL: Redis connection string
#   - JWT_SECRET: JWT signing secret (CHANGE IN PRODUCTION!)
#   - OPENAI_API_KEY: OpenAI API key for NLP features (optional)
#   - VECTOR_DB_DSN: Vector database DSN for embeddings (optional)
#
# Usage:
#   docker-compose up -d                          # Start all services (mock mode)
#   USE_MOCK_DATA=false docker-compose up -d      # Start in real mode
#   docker-compose down                           # Stop all services
#   docker-compose logs -f                        # View logs
#
# Note: When USE_MOCK_DATA=true (default), the backend will use mock repositories
# and health checks will return "ready" status (no DB/Redis checks are performed).
#
# When USE_MOCK_DATA=false, the backend will:
#   - Connect to PostgreSQL database for data persistence
#   - Connect to Redis for token storage
#   - Include DB/Redis in health checks (returns 503 if unavailable)

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: superdash-backend
    ports:
      - "8080:8080"
    environment:
      # Application settings
      - ENV=development
      - PORT=8080
      - LOG_LEVEL=info
      # Mock data mode - set to false to use real database
      # Can be overridden: USE_MOCK_DATA=false docker-compose up -d
      - USE_MOCK_DATA=${USE_MOCK_DATA:-true}
      # Database connection
      - DATABASE_URL=postgres://superdash:superdash123@postgres:5432/superdashboard?sslmode=disable
      # Redis connection
      - REDIS_URL=redis://redis:6379
      # SECURITY: Change this secret in production! Use a strong random value.
      - JWT_SECRET=${JWT_SECRET:-CHANGE_ME_IN_PRODUCTION_use_strong_random_secret}
      # OpenAI API key for NLP features (optional, leave empty if not using)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      # Vector database DSN for embeddings (optional, uses same as DATABASE_URL by default)
      - VECTOR_DB_DSN=${VECTOR_DB_DSN:-postgres://superdash:superdash123@postgres:5432/superdashboard?sslmode=disable}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: superdash-frontend
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=http://backend:8080
      - NEXT_PUBLIC_WS_URL=ws://backend:8080/ws
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped

  postgres:
    image: postgres:15-alpine
    container_name: superdash-postgres
    environment:
      POSTGRES_USER: superdash
      POSTGRES_PASSWORD: superdash123
      POSTGRES_DB: superdashboard
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U superdash"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: superdash-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  postgres_data:
  redis_data:
